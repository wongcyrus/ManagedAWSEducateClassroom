AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'managed-aws-educate-classroom

  '
Metadata:
  AWS::ServerlessRepo::Application:
    Name: managed-aws-educate-classroom
    Description: "A centralized control to all student\u2019s AWS Educate Classroom\
      \ Account.  Educators can create and delete cloudformation stack in all student's\
      \ AWS Account in each AWS Educate Classroom.\n"
    Author: Cyrus Wong
    SpdxLicenseId: Apache-2.0
    LicenseUrl: s3://cyruswong-sam-repo/175792518e4ac015ab6696d16c4f607e
    ReadmeUrl: s3://cyruswong-sam-repo/c029e994fb0fec6d341fb68dcc8152c3
    Labels:
    - cloudformation
    - AWS_Educate
    HomePageUrl: https://www.linkedin.com/pulse/how-use-managed-aws-educate-classroom-calendar-build-wong/
    SemanticVersion: 0.0.1
    SourceCodeUrl: https://github.com/wongcyrus/managed-aws-educate-classroom
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: AWS SES Inbox (Optional)
      Parameters:
      - SesInboxTopic
      - BucketName
    - Label:
        default: Teacher Email Settings (Optional)
      Parameters:
      - TeacherCommandEmail
      - TeacherEmailDomains
    - Label:
        default: Student Email Settings (Optional)
      Parameters:
      - StudentCommandEmail
      - StudentEmailDomains
    - Label:
        default: reCAPTCHA v3 (Optional)
      Parameters:
      - RecaptchaSiteKey
      - RecaptchaSercetKey
    ParameterLabels:
      CalendarUrl:
        default: Public Class Schedule Calendar Url
      SesInboxTopic:
        default: AWS SES Inbox email SNS Topic
      BucketName:
        default: AWS SES Inbox Bucket
      StudentCommandEmail:
        default: Student Command Email Address
      StudentEmailDomains:
        default: White List Student email domain
      TeacherCommandEmail:
        default: Teacher Command Email Address
      TeacherEmailDomains:
        default: White List Teacher email domain
      RecaptchaSiteKey:
        default: reCAPTCHA Site Key
      RecaptchaSercetKey:
        default: reCAPTCHA Sercet Key
Parameters:
  SesInboxTopic:
    Type: String
    Default: ''
  CalendarUrl:
    Type: String
    Default: ''
  BucketName:
    Type: String
    Default: ''
  StudentCommandEmail:
    Type: String
    Default: ''
  StudentEmailDomains:
    Type: String
    Default: ''
  TeacherCommandEmail:
    Type: String
    Default: ''
  TeacherEmailDomains:
    Type: String
    Default: ''
  RecaptchaSiteKey:
    Type: String
    Default: ''
    NoEcho: true
  RecaptchaSercetKey:
    Type: String
    Default: ''
    NoEcho: true
Globals:
  Function:
    Handler: app.lambdaHandler
    Timeout: 180
    Runtime: nodejs12.x
    Layers:
    - Ref: CommonLayer
    Environment:
      Variables:
        StudentAccountTable:
          Ref: StudentAccountTable
        GraderParameterTable:
          Ref: GraderParameterTable
        ClassroomBucket:
          Ref: ClassroomBucket
Conditions:
  UseAwsSesInbox:
    Fn::Not:
    - Fn::Equals:
      - Ref: SesInboxTopic
      - ''
  UseCalendarTrigger:
    Fn::Not:
    - Fn::Equals:
      - Ref: CalendarUrl
      - ''
Resources:
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: managed-aws-educate-classroom-common-layer
      Description: Common code.
      ContentUri: s3://cyruswong-sam-repo/80823813b96308b57c1692325761150a
      RetentionPolicy: Delete
      CompatibleRuntimes:
      - nodejs12.x
  SetupStudentAccountQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 180
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - SetupStudentAccountDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  SetupStudentAccountDeadLetterQueue:
    Type: AWS::SQS::Queue
  SetupStudentAccountSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseAwsSesInbox
    Properties:
      TopicArn:
        Ref: SesInboxTopic
      Endpoint:
        Fn::GetAtt:
        - SetupStudentAccountQueue
        - Arn
      Protocol: sqs
      FilterPolicy:
        receiver:
        - Ref: StudentCommandEmail
        intentName:
        - RegisterStudentAccountIntent
        senderEmailDomain:
          Fn::Split:
          - ','
          - Ref: StudentEmailDomains
  SetupStudentAccountQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseAwsSesInbox
    Properties:
      Queues:
      - Ref: SetupStudentAccountQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - SetupStudentAccountQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Ref: SesInboxTopic
  SetupStudentAccountFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/df6de4afd32db91ca51742badd8b19ab
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - S3ReadPolicy:
          BucketName:
            Ref: ClassroomBucket
      - Fn::If:
        - UseAwsSesInbox
        - S3ReadPolicy:
            BucketName:
              Ref: BucketName
        - Ref: AWS::NoValue
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - SetupStudentAccountQueue
              - Arn
            BatchSize: 1
  StartInstanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/76d09c3c1b24690d8d8676765e0ea02e
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
  CreateStudentStackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/d17d6016984c0090df0760cef4e206a9
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - S3ReadPolicy:
          BucketName:
            Ref: ClassroomBucket
      - Fn::If:
        - UseAwsSesInbox
        - S3ReadPolicy:
            BucketName:
              Ref: BucketName
        - Ref: AWS::NoValue
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
      Environment:
        Variables:
          RdpFileUrl:
            Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/rdp/login.rdp
          PemKeyFileUrl:
            Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/pem/key.pem
  CreateClassroomQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 180
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - CreateClassroomDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  CreateClassroomDeadLetterQueue:
    Type: AWS::SQS::Queue
  CreateClassroomSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseAwsSesInbox
    Properties:
      TopicArn:
        Ref: SesInboxTopic
      Endpoint:
        Fn::GetAtt:
        - CreateClassroomQueue
        - Arn
      Protocol: sqs
      FilterPolicy:
        receiver:
        - Ref: TeacherCommandEmail
        intentName:
        - CreateClassroomIntent
        senderEmailDomain:
          Fn::Split:
          - ','
          - Ref: TeacherEmailDomains
  CreateClassroomQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseAwsSesInbox
    Properties:
      Queues:
      - Ref: CreateClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - CreateClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Ref: SesInboxTopic
  CreateClassroomFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/26b3c6f84a542950dd804e9039b65a3d
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - S3ReadPolicy:
          BucketName:
            Ref: ClassroomBucket
      - Fn::If:
        - UseAwsSesInbox
        - S3ReadPolicy:
            BucketName:
              Ref: BucketName
        - Ref: AWS::NoValue
      - LambdaInvokePolicy:
          FunctionName:
            Ref: CreateStudentStackFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StartInstanceFunction
      Environment:
        Variables:
          CreateStudentStackFunctionArn:
            Fn::GetAtt:
            - CreateStudentStackFunction
            - Arn
          StartInstanceFunctionArn:
            Fn::GetAtt:
            - StartInstanceFunction
            - Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - CreateClassroomQueue
              - Arn
            BatchSize: 1
  StopInstanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/1a25b9f9a963b403543e50878efd5c1f
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
  DeleteStudentStackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/b9a05b504f91c63d2e6d79298837f018
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - S3ReadPolicy:
          BucketName:
            Ref: ClassroomBucket
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
  DeleteClassroomQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 180
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DeleteClassroomDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  DeleteClassroomDeadLetterQueue:
    Type: AWS::SQS::Queue
  DeleteClassroomSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseAwsSesInbox
    Properties:
      TopicArn:
        Ref: SesInboxTopic
      Endpoint:
        Fn::GetAtt:
        - DeleteClassroomQueue
        - Arn
      Protocol: sqs
      FilterPolicy:
        receiver:
        - Ref: TeacherCommandEmail
        intentName:
        - DeleteClassroomIntent
        senderEmailDomain:
          Fn::Split:
          - ','
          - Ref: TeacherEmailDomains
  DeleteClassroomQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseAwsSesInbox
    Properties:
      Queues:
      - Ref: DeleteClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - DeleteClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Ref: SesInboxTopic
  DeleteClassroomFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/05a9e118783bd8e7ae526ae5759ae6a7
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - S3ReadPolicy:
          BucketName:
            Ref: ClassroomBucket
      - Fn::If:
        - UseAwsSesInbox
        - S3ReadPolicy:
            BucketName:
              Ref: BucketName
        - Ref: AWS::NoValue
      - LambdaInvokePolicy:
          FunctionName:
            Ref: DeleteStudentStackFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: StopInstanceFunction
      Environment:
        Variables:
          DeleteStudentStackFunctionArn:
            Fn::GetAtt:
            - DeleteStudentStackFunction
            - Arn
          StopInstanceFunctionArn:
            Fn::GetAtt:
            - StopInstanceFunction
            - Arn
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - DeleteClassroomQueue
              - Arn
            BatchSize: 1
  GradeClassroomQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - GradeClassroomDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  GradeClassroomDeadLetterQueue:
    Type: AWS::SQS::Queue
  GradeClassroomSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseAwsSesInbox
    Properties:
      TopicArn:
        Ref: SesInboxTopic
      Endpoint:
        Fn::GetAtt:
        - GradeClassroomQueue
        - Arn
      Protocol: sqs
      FilterPolicy:
        receiver:
        - Ref: TeacherCommandEmail
        intentName:
        - GradeClassroomIntent
        senderEmailDomain:
          Fn::Split:
          - ','
          - Ref: TeacherEmailDomains
  GradeClassroomQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseAwsSesInbox
    Properties:
      Queues:
      - Ref: GradeClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - GradeClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Ref: SesInboxTopic
  GradeClassroomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Timeout: 300
      CodeUri: s3://cyruswong-sam-repo/4d62e21c1bc12502b35547885373be28
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: GraderParameterTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: StudentAccountTable
      - Fn::If:
        - UseAwsSesInbox
        - S3ReadPolicy:
            BucketName:
              Ref: BucketName
        - Ref: AWS::NoValue
      - S3CrudPolicy:
          BucketName:
            Ref: ClassroomGradeBucket
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Resource:
            Fn::Sub: arn:aws:iam::*:role/crossaccountteacher${AWS::AccountId}
        - Effect: Allow
          Action: lambda:InvokeFunction
          Resource:
            Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*MarkerFunction*
        - Effect: Allow
          Action: lambda:listFunctions
          Resource: '*'
      Environment:
        Variables:
          GraderParameterTable:
            Ref: GraderParameterTable
          ClassroomGradeBucket:
            Ref: ClassroomGradeBucket
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - GradeClassroomQueue
              - Arn
            BatchSize: 1
  StudentAccountTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: classroomName
        AttributeType: S
      - AttributeName: email
        AttributeType: S
      KeySchema:
      - AttributeName: classroomName
        KeyType: HASH
      - AttributeName: email
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: emailGSI
        KeySchema:
        - AttributeName: email
          KeyType: HASH
        - AttributeName: classroomName
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  GraderParameterTable:
    Type: AWS::Serverless::SimpleTable
  ClassroomBucket:
    Type: AWS::S3::Bucket
  ClassroomGradeBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
    DeletionPolicy: Retain
  ClassroomGradeBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
        - Sid: PublicReadForGetBucketObjects
          Effect: Allow
          Principal: '*'
          Action: s3:GetObject
          Resource:
            Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: ClassroomGradeBucket
              - /*
      Bucket:
        Ref: ClassroomGradeBucket
  HttpApi:
    Type: AWS::Serverless::HttpApi
  SetupStudentAccountWebUiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/8d3104692c66ec4c1a337fa65face3cd
      Handler: setupStudentAccount.lambdaHandler
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: SetupStudentAccountFunction
      Environment:
        Variables:
          SetupStudentAccountFunction:
            Fn::GetAtt:
            - SetupStudentAccountFunction
            - Arn
          RecaptchaSiteKey:
            Ref: RecaptchaSiteKey
          RecaptchaSercetKey:
            Ref: RecaptchaSercetKey
      Events:
        ExplicitApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /
  SetupGraderParametersWebUiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/8d3104692c66ec4c1a337fa65face3cd
      Handler: setupGraderParameters.lambdaHandler
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: GraderParameterTable
      Environment:
        Variables:
          GraderParameterTable:
            Ref: GraderParameterTable
          RecaptchaSiteKey:
            Ref: RecaptchaSiteKey
          RecaptchaSercetKey:
            Ref: RecaptchaSercetKey
      Events:
        ExplicitApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /graderparameter
  GetRdpFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/8d3104692c66ec4c1a337fa65face3cd
      Handler: getRdp.lambdaHandler
      Events:
        ExplicitApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: GET
            Path: /rdp/login.rdp
  GetPemKeyFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/8d3104692c66ec4c1a337fa65face3cd
      Handler: getPemKey.lambdaHandler
      Events:
        ExplicitApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: GET
            Path: /pem/key.pem
  GetCrossAccountRoleWebUiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://cyruswong-sam-repo/8d3104692c66ec4c1a337fa65face3cd
      Handler: getCrossAccount.lambdaHandler
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: StudentAccountTable
      Environment:
        Variables:
          SetupStudentAccountFunction:
            Fn::GetAtt:
            - SetupStudentAccountFunction
            - Arn
      Events:
        ExplicitApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Method: ANY
            Path: /getCrossAccount.html
  CalendarEventsApplication:
    Type: AWS::Serverless::Application
    Condition: UseCalendarTrigger
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:111964674713:applications/calendar-trigger
        SemanticVersion: 0.0.1
      Parameters:
        CalendarUrl:
          Ref: CalendarUrl
  DeleteClassroomCalendarEventsSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseCalendarTrigger
    Properties:
      TopicArn:
        Fn::GetAtt:
        - CalendarEventsApplication
        - Outputs.CanlenderEventStopTopic
      Endpoint:
        Fn::GetAtt:
        - DeleteClassroomQueue
        - Arn
      Protocol: sqs
  DeleteClassroomCalendarEventsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseCalendarTrigger
    Properties:
      Queues:
      - Ref: DeleteClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - DeleteClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Fn::GetAtt:
                - CalendarEventsApplication
                - Outputs.CanlenderEventStopTopic
  CreateClassroomCalendarEventsSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseCalendarTrigger
    Properties:
      TopicArn:
        Fn::GetAtt:
        - CalendarEventsApplication
        - Outputs.CanlenderEventStartTopic
      Endpoint:
        Fn::GetAtt:
        - CreateClassroomQueue
        - Arn
      Protocol: sqs
  CreateClassroomCalendarEventsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseCalendarTrigger
    Properties:
      Queues:
      - Ref: CreateClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - CreateClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Fn::GetAtt:
                - CalendarEventsApplication
                - Outputs.CanlenderEventStartTopic
  GradeClassroomCalendarEventsSubscription:
    Type: AWS::SNS::Subscription
    Condition: UseCalendarTrigger
    Properties:
      TopicArn:
        Fn::GetAtt:
        - CalendarEventsApplication
        - Outputs.CanlenderEventStartTopic
      Endpoint:
        Fn::GetAtt:
        - GradeClassroomQueue
        - Arn
      Protocol: sqs
  GradeClassroomCalendarEventsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: UseCalendarTrigger
    Properties:
      Queues:
      - Ref: GradeClassroomQueue
      PolicyDocument:
        Version: '2008-10-17'
        Id: PublicationPolicy
        Statement:
        - Sid: Allow-SNS-SendMessage
          Effect: Allow
          Principal:
            AWS: '*'
          Action:
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - GradeClassroomQueue
            - Arn
          Condition:
            ArnEquals:
              aws:SourceArn:
                Fn::GetAtt:
                - CalendarEventsApplication
                - Outputs.CanlenderEventStartTopic
Outputs:
  SetupStudentAccountFunction:
    Description: SetupStudentAccountFunction
    Value:
      Fn::GetAtt:
      - SetupStudentAccountFunction
      - Arn
  CreateClassroomFunction:
    Description: CreateClassroomFunction
    Value:
      Fn::GetAtt:
      - CreateClassroomFunction
      - Arn
  DeleteClassroomFunction:
    Description: DeleteClassroomFunction
    Value:
      Fn::GetAtt:
      - DeleteClassroomFunction
      - Arn
  GradeClassroomFunction:
    Description: GradeClassroomFunction
    Value:
      Fn::GetAtt:
      - GradeClassroomFunction
      - Arn
  ClassroomBucket:
    Value:
      Ref: ClassroomBucket
  StudentRegistrationUrl:
    Description: URL of your Student to Signup and studentEmail is optional.
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/?classroomName=ChangeToYourClassName&studentEmail=YourStudentEmailAddress
  SetupGraderParametersUrl:
    Description: URL of your Student to setup grader parameters and studentEmail is
      optional.
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/graderparameter?classroomName=ChangeToYourClassName&gradeFunction=ChangeToYourGraderLambdaFunctionName&studentEmail=YourStudentEmailAddress
  GetCrossAccountAssumeRoleUrl:
    Description: URL for teacher to get the assume role URL for your student account.
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}/getCrossAccount.html?classroomName=ChangeToYourClassName
  ClassroomGradeBucketSecureURL:
    Value:
      Fn::Join:
      - ''
      - - https://
        - Fn::GetAtt:
          - ClassroomGradeBucket
          - DomainName
